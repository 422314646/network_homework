<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>部门列表</title>
    <meta charset="utf-8">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="layui/css/layui.css"  media="all">
    <!-- 注意：如果你直接复制所有代码到本地，上述css路径需要改成你本地的 -->
    <!--<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />-->
    <script type="text/javascript" src="./js/jquery.js"></script>
    <!-- <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/dt/dt-1.10.18/datatables.min.css"/>-->
    <script type="text/javascript" src="https://cdn.datatables.net/v/dt/dt-1.10.18/datatables.min.js"></script>
    <script type="text/javascript" src="./js/md5.js"></script>
    <script type="text/javascript" src="./js/highcharts.js"></script>
    <script type="text/javascript" src="./js/modules/exporting.js"></script>
    <script type="text/javascript" src="./js/highcharts-3d.js"></script>
    <script src="https://cdn.bootcss.com/layer/3.1.0/layer.js" type="text/javascript" charset="utf-8"></script>
    <script type="text/javascript" src="./config/utils.js"></script>
    <script src="layui/layui.js" charset="utf-8"></script>
</head>
<body>
<table class="layui-hide" id="test" lay-filter="demo"></table>
<div style="display: none;"id="userTool">
    <div>
        <button class="layui-btn layui-btn-normal" type="button" onclick="addOutputInfo()">添加事务</button>
        <button class="layui-btn layui-btn-normal" type="button" onclick="location.reload()">刷新</button>


        <select id="trans-status">
                <option value="">事务状态</option>
                <option value="1">待办事项</option>
                <option value="2">处理中事项</option>
                <option value="3">已完成事项</option>
        </select>
        <select id="trans-type">
            <option value="">事务类型</option>
            <option value="1">安全事件通报</option>
            <option value="2">热点事件发布</option>
        </select>
        <select id="event-type">
            <option value="">事件类型</option>
            <option value="1">违处信息</option>
            <option value="2">网络攻击</option>
            <option value="2">恶意软件</option>
            <option value="2">信息泄露</option>
            <option value="2">安全威胁/漏洞</option>

        </select>
        <select id="trans_handler_department">
            <option value="">辖区选择</option>
        </select>
        <input type="text" placeholder="企业名称" autocomplete="off" class="layui-input" id="trans-handler">
        <button class="layui-btn" id="trans_search" onclick="trans_query()">查询</button>


<!--        <div style="float: right">-->
<!--&lt;!&ndash;            <input id="1" style="height: 30px; border-radius:20px" placeholder="事件类型" />&ndash;&gt;-->
<!--            <input id="2" style="height: 30px; border-radius:5px" placeholder=" 辖区"/>-->
<!--            <input id="3" style="height: 30px; border-radius:5px" placeholder=" 企业"/>-->
<!--            <button style="border-radius:5px" class="layui-btn layui-btn-sm" type="button" onclick="addOutputInfo()">搜索</button>-->
<!--        </div>-->
    </div>
</div>
</body>

<!-- 注意：如果你直接复制所有代码到本地，上述js路径需要改成你本地的 -->

<script>
    $.ajax({
        type: "get",
        url: "/department",
        data: {page: 1, limit: 20, type: 3},
        success: function (result) {
            console.log(result);
            console.log(result.departments);
            for (i = 0; i < result.count; i++) {
                $("#trans_handler_department").append("<option value=" + result.departments[i].id + ">" + result.departments[i].name + "</option>");
            }
        }
    })
</script>

<script>
    var evenType = new Map();
    evenType[1] = '违处信息';
    evenType[2] = '网络攻击';
    evenType[3] = '恶意软件';
    evenType[4] = '信息泄露';
    evenType[5] = '安全威胁/漏洞';

    var eventype1 = new Map();
    eventype1[1] = '待办事项';
    eventype1[2] = '处理中事项';
    eventype1[3] = '已完成事项';

    var eventype2 = new Map();
    eventype2[1] = '安全事件通报';
    eventype2[2] = '热点事件发布';

    var tableInst = {};
    layui.use('table', function(){
        var table = layui.table;

        tableInst = table.render({
            elem: '#test'
            ,url:'/transaction'
            ,method:"get"
            ,toolbar: "#userTool"
            ,title: '部门数据表'
            ,page:true
            ,limit:20
            ,parseData: function(res){ //将原始数据解析成 table 组件所规定的数据
                console.log(res)
                return {
                    "code": 0, //解析接口状态
                    "msg": "正在加载", //解析提示文本
                    "count": res.count, //解析数据长度
                    "data": res.transactions //解析数据列表
                };
            }
            ,cellMinWidth: 80 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
            ,cols: [[
                {field:'seq', width:'6%', title: '编号', type: 'numbers'}
                ,{field:'id', title: '事件编号',id:'id', hide:true}
                ,{field:'publisher', width:'10%', title: '发布者ID', sort: true}
                ,{field:'created_at', width:'15%', title: '事务创建时间', sort: true}
                ,{field:'type', width:'10%', title: '事件类型', sort: true
                    ,templet: function(d){
                         return evenType[d.type];
                } }
                ,{field:'status', width:'10%', title: '事件状态', sort: true
                    ,templet: function (d) {
                        return eventype1[d.status];
                    }}
                ,{field:'detail', width:'10%', title: '具体事件描述'}
                ,{field:'tran_type', width:'8%', title: '事务类型', sort: true
                    ,templet: function (d) {
                        return eventype2[d.tran_type];
                    }}
                ,{field:'handler_department', width:'10%', title: '辖区', sort: true}
                ,{field:'handler', width:'10%', title: '处理事件用户', sort: true}
                ,{fixed: 'right', width:150, align:'center', toolbar: '#barDemo',width:'10%'}
            ]]
        });
    });


    // $('#trans_search').on('click', function () {
    function trans_query() {
            var params = {
                "page": 1,
                "limit": 200,
            };
            var status = document.getElementById( "trans-status").value;
            if (status.length > 0) {
                params.status = parseInt(status);
            }
            var type = document.getElementById( "event-type").value;
            if (type.length > 0) {
                params.type = parseInt(type);
            }
            var tran_type = document.getElementById( "trans-type").value;
            if (tran_type.length > 0) {
                params.tran_type = parseInt(tran_type);
            }
            var handler_department = document.getElementById("trans_handler_department").value;
            if (handler_department.length > 0) {
                // params.handler_department = parseInt(handler_department);
                params['handler-department'] = parseInt(handler_department);
            }
            var handler = document.getElementById("trans-handler").value;
            console.log(params);

            tableInst.reload({
                'where': params
            })
        // })
    }

</script>
<script type="text/html" id="barDemo">

    <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
    <!--<a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>-->
</script>

<script>

    layui.use('table', function(){
        var table = layui.table;
        table.on('tool(demo)', function(obj){
            var data = obj.data;
            if(obj.event === 'detail'){
                layer.msg('ID：'+ data.id + ' 的查看操作');
                layer.alert('详细信息：<br>'+ JSON.stringify(data))
            } else if(obj.event === 'del'){
                layer.confirm('真的删除行么', function(index){
                    obj.del();
                    var data=obj.data;
                    console.log(data.id);
                    layer.close(index);
                    $.ajax({
                        type : "DELETE",  //提交方式
                        url : "/department/"+data.id,//路径
                        success : function(result) {
                            console.log(result);
                            alert("删除成功");
                        },
                        error: function (XMLHttpRequest, textStatus, errorThrown) {
                            console.log(XMLHttpRequest.responseText);
                            var j = JSON.parse(XMLHttpRequest.responseText);
                            alert(j.error);
                        }
                    });

                });
            } else if(obj.event === 'edit'){
                //layer.alert('编辑行：<br>'+ JSON.stringify(data))
                localStorage.setItem("data1",JSON.stringify(data));
                layer.open({
                    type: 2,
                    skin: 'layui-layer-rim', //加上边框
                    area: ['520px', '340px'], //宽高
                    content: 'device_manage_update.html',
                    title:"修改事务信息"
                    //layer提供了5种层类型。可传入的值有：0（信息框，默认）1（页面层）2（iframe层）3（加载层）4（tips层）


                });
            }
        });

    });

    //增加一个支出数据
    function addOutputInfo(){
        layer.open({
            type: 2,
            skin: 'layui-layer-rim', //加上边框
            area: ['520px', '355px'], //宽高
            content: 'device_manage_add.html',
            title:"添加信息"
        });
    }

</script>

</html>